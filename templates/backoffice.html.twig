{% extends "base.html.twig" %}

{% block title %}Backoffice - Administration
{% endblock %}

{% block body %}
	<div class="backoffice-container">
		<div class="page-header">
			<h1>Backoffice</h1>
			<p>Administration des utilisateurs et des liens</p>
		</div>

		<!-- Flash Messages -->
		{% for type, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ type == 'error' ? 'danger' : type }} alert-dismissible fade show" role="alert">
					{{ message }}
					<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
				</div>
			{% endfor %}
		{% endfor %}

		<!-- Onglets -->
		<div class="tabs-container">
			<div class="tabs-nav">
				{% if is_granted('ROLE_ADMIN') %}
					<a href="{{ path('app_backoffice', {tab: 'users'}) }}" class="tab-button {{ activeTab == 'users' ? 'active' : '' }}">
						<i class="bi bi-people"></i>
						Utilisateurs ({{ users|length }})
					</a>
				{% endif %}
				<a href="{{ path('app_backoffice', {tab: 'links'}) }}" class="tab-button {{ activeTab == 'links' ? 'active' : '' }}">
					<i class="bi bi-link-45deg"></i>
					Liens ({{ links|length }})
				</a>
			</div>

			<!-- Contenu des onglets -->
			<div
				class="tabs-content">
				<!-- Onglet Utilisateurs -->
				{% if is_granted('ROLE_ADMIN') and activeTab == 'users' %}
					<div class="tab-panel active" id="users-tab">
						<div class="tab-header">
							<div class="tab-actions">
								<a href="{{ path('app_user_create') }}" class="btn btn-primary">
									<i class="bi bi-plus"></i>
									Ajouter un utilisateur
								</a>
							</div>
						</div>

						{% if users|length > 0 %}
							<div class="data-table">
								<table>
									<thead>
										<tr>
											<th>ID</th>
											<th>Nom d'utilisateur</th>
											<th>Rôles</th>
											<th>Nombre de liens</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for user in users %}
											<tr>
												<td>{{ user.id }}</td>
												<td>{{ user.username }}</td>
												<td>
													{% for role in user.roles %}
														<span class="badge bg-primary">{{ role }}</span>
													{% endfor %}
												</td>
												<td>{{ user.links|length }}</td>
												<td>
													<div class="action-buttons">
														<a href="{{ path('app_user_edit', {id: user.id}) }}" class="btn btn-sm btn-warning">
															<i class="bi bi-pencil"></i>
														</a>
														<form method="post" action="{{ path('app_user_delete', {id: user.id}) }}" style="display: inline;">
															<input type="hidden" name="_token" value="{{ csrf_token('delete-user-' ~ user.id) }}">
															<button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')">
																<i class="bi bi-trash"></i>
															</button>
														</form>
													</div>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<div class="empty-state">
								<i class="bi bi-people"></i>
								<h4>Aucun utilisateur</h4>
								<p>Aucun utilisateur trouvé dans la base de données.</p>
							</div>
						{% endif %}
					</div>
				{% endif %}

				<!-- Onglet Liens -->
				{% if activeTab == 'links' or (not is_granted('ROLE_ADMIN') and activeTab != 'users') %}
					<div class="tab-panel active" id="links-tab">
						<div class="tab-header">
							<div class="tab-actions">
								<a href="{{ path('app_link_create') }}" class="btn btn-primary">
									<i class="bi bi-plus"></i>
									Ajouter un lien
								</a>
							</div>
						</div>

						{% if links|length > 0 %}
							<div class="data-table">
								<table>
									<thead>
										<tr>
											<th>ID</th>
											<th>Titre</th>
											<th>URL</th>
											<th>Utilisateur</th>
											<th>Tags</th>
											<th>Date</th>
											<th>Actions</th>
										</tr>
									</thead>
									<tbody>
										{% for link in links %}
											<tr>
												<td>{{ link.id }}</td>
												<td>{{ link.title }}</td>
												<td>
													<a href="{{ link.url }}" target="_blank" class="link-url">
														{% if link.url|length > 30 %}
															{{ link.url|slice(0, 30) }}...
														{% else %}
															{{ link.url }}
														{% endif %}
													</a>
												</td>
												<td>{{ link.user ? link.user.username : 'Anonyme' }}</td>
												<td>
													{% if link.tags|length > 0 %}
														{% for tag in link.tags %}
															<span class="tag-badge-small">{{ tag.name }}</span>
														{% endfor %}
													{% else %}
														<span class="text-muted">Aucun tag</span>
													{% endif %}
												</td>
												<td>{{ link.createdAt|date('d/m/Y') }}</td>
												<td>
													<div class="action-buttons">
														<a href="{{ link.url }}" target="_blank" class="btn btn-sm btn-info">
															<i class="bi bi-box-arrow-up-right"></i>
														</a>
														<a href="{{ path('app_link_edit', {id: link.id}) }}" class="btn btn-sm btn-warning">
															<i class="bi bi-pencil"></i>
														</a>
														<form method="post" action="{{ path('app_link_delete', {id: link.id}) }}" style="display: inline;">
															<input type="hidden" name="_token" value="{{ csrf_token('delete-link-' ~ link.id) }}">
															<button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Êtes-vous sûr de vouloir supprimer ce lien ?')">
																<i class="bi bi-trash"></i>
															</button>
														</form>
													</div>
												</td>
											</tr>
										{% endfor %}
									</tbody>
								</table>
							</div>
						{% else %}
							<div class="empty-state">
								<i class="bi bi-link-45deg"></i>
								<h4>Aucun lien</h4>
								<p>Aucun lien trouvé dans la base de données.</p>
							</div>
						{% endif %}
					</div>
				{% endif %}
			</div>
		</div>
	</div>
{% endblock %}
